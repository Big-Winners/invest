<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Now</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='invest.css') }}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            padding-top: 20px;
        }

        .plan-buttons .btn {
            margin: 5px;
            padding: 12px 24px;
            font-weight: bold;
        }

        .plan-section {
            display: none;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 600px;
        }

        .plan-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner-border-sm {
            margin-left: 10px;
        }

        .crypto-address {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .copy-btn {
            margin-left: 10px;
            padding: 3px 10px;
            font-size: 0.85rem;
        }

        .plan-card {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .plan-card h3 {
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .menu-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            color: #007bff;
            background: white;
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 20px;
            width: 250px;
            z-index: 1000;
        }

        .profile-picture-container img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #007bff;
            object-fit: cover;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            background: #343a40;
            color: white;
        }

        .crypto-option {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .crypto-option:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .crypto-option.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .payment-method-tabs {
            margin-bottom: 20px;
        }

        .payment-method-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
        }

        .payment-method-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
        }

        .payment-option-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .payment-option-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .payment-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #0d6efd;
        }

        .crypto-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .crypto-icon.btc {
            color: #f7931a;
        }

        .crypto-icon.erc20 {
            color: #2775ca;
        }

        .crypto-icon.trc20 {
            color: #ff6b01;
        }

        .card-options .payment-option-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .card-options .payment-option-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .card-options .payment-option-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .payment-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #0d6efd;
        }

        .card-icons {
            font-size: 30px;
            margin-right: 10px;
        }

        .card-icons.visa {
            color: #1a1f71;
        }

        .card-icons.mastercard {
            color: #eb001b;
        }

        .card-icons.amex {
            color: #2e77bc;
        }

        .payment-option-card i.fa-check-circle {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .payment-option-card.selected i.fa-check-circle {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="menu-container">
        <i class="fas fa-bars menu-icon" onclick="toggleMenu()"></i>
        <div class="menu-dropdown" id="menuDropdown">
            <!-- Home Section -->
            <div class="menu-item">
                <a href="/dashboard"><i class="fas fa-home"></i> <span>Home</span></a>
            </div>

            <!-- Profile Section -->
            <div class="menu-item profile-section">
                <a href="javascript:void(0);" onclick="toggleProfileDetails()">
                    <i class="fas fa-user-circle"></i> <span>Profile</span>
                </a>
            </div>
            <div class="profile-details" id="profileDetails">
                <div class="profile-picture-container" id="profilePictureContainer">
                    <img id="profilePicture"
                        src="{{ url_for('static', filename='uploads/' + session.get('profile_picture', 'default.jpg')) }}"
                        alt="Profile Picture">
                </div>
                <p><i class="fas fa-user"></i> <strong>Username:</strong> {{ session.get('user', 'Guest') }}</p>
                <p><i class="fas fa-envelope"></i> <strong>Email:</strong> {{ session.get('user_email', 'Not available') }}</p>
            </div>

            <!-- Subscription Plans -->
            <h3><i class="fas fa-file-contract"></i> Investment Plans</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li><i class="fas fa-check text-success"></i> <a href="/invest" style="text-decoration: none;">Standard Plan</a></li>
                <li><i class="fas fa-crown text-warning"></i> <a href="/invest" style="text-decoration: none;">VIP Plan</a></li>
            </ul>

            <!-- More Options -->
            <h3><i class="fas fa-list"></i> More Options</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li><a href="/account-settings"><i class="fas fa-cog"></i> <span>Account Settings</span></a></li>
                <li><a href="/about"><i class="fas fa-info-circle"></i> <span>About Us</span></a></li>
                <li><a href="{{ url_for('terms') }}"><i class="fas fa-file-alt"></i> <span>Terms & Conditions</span></a></li>
                <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </div>
    </div>

    <div class="container mt-5">
        <h2 class="text-center text-primary mb-4"><i class="fas fa-money-check-alt"></i> Select Your Investment Plan</h2>
        <p class="text-center text-muted mb-4">Choose between our premium investment plans</p>

        <!-- Investment Plan Buttons (Only Standard and VIP) -->
        <div class="plan-buttons text-center mb-5">
            <button class="btn btn-primary btn-lg" onclick="showPlan('standard')">
                <i class="fas fa-star"></i> Standard Plan
            </button>
            <button class="btn btn-warning btn-lg" onclick="showPlan('vip')">
                <i class="fas fa-crown"></i> VIP Plan
            </button>
        </div>

        <!-- Standard Plan Section -->
        <div id="standard" class="plan-section">
            <div class="plan-card">
                <h3 class="text-center mb-4"><i class="fas fa-star"></i> Standard Plan</h3>
                <div class="form-group">
                    <select id="amount_standard" class="form-select form-select-lg">
                        <option value="100">Invest $100 → Earn $500</option>
                        <option value="150">Invest $150 → Earn $750</option>
                        <option value="200">Invest $200 → Earn $1000</option>
                        <option value="250">Invest $250 → Earn $1250</option>
                        <option value="300">Invest $300 → Earn $1500</option>
                        <option value="350">Invest $350 → Earn $1750</option>
                    </select>
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-success btn-lg" onclick="payNow('standard')">
                        <i class="fas fa-lock"></i> Invest Now
                    </button>
                </div>
            </div>
        </div>

        <!-- VIP Plan Section -->
        <div id="vip" class="plan-section">
            <div class="plan-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3 class="text-center mb-4"><i class="fas fa-crown"></i> VIP Plan</h3>
                <div class="form-group">
                    <select id="amount_vip" class="form-select form-select-lg">
                        <option value="400">Invest $400 → Earn $2000</option>
                        <option value="500">Invest $500 → Earn $2500</option>
                        <option value="600">Invest $600 → Earn $3000</option>
                        <option value="700">Invest $700 → Earn $3500</option>
                        <option value="800">Invest $800 → Earn $4000</option>
                        <option value="900">Invest $900 → Earn $4500</option>
                        <option value="1000">Invest $1000 → Earn $5000</option>
                    </select>
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-warning btn-lg" onclick="payNow('vip')">
                        <i class="fas fa-gem"></i> VIP Investment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <script>
        // Crypto wallet addresses
        const CRYPTO_ADDRESSES = {
            "BTC": "13EcmrfxyUSKDrWbJBsjRU2ho92RJdTixL",
            "USDT_ERC20": "0x7a3544ab71d616f0f858913e416817c22631b830",
            "USDT_TRC20": "TUe3Qdf9d4xueX9F7viJLZCwRZxgx2hbze"
        };
        
        const CRYPTO_NAMES = {
            "BTC": "Bitcoin (BTC)",
            "USDT_ERC20": "USDT (ERC20)",
            "USDT_TRC20": "USDT (TRC20)"
        };

        const CRYPTO_ICONS = {
            "BTC": "fab fa-bitcoin",
            "USDT_ERC20": "fas fa-coins",
            "USDT_TRC20": "fas fa-coins"
        };

        // Store global variables
        let selectedPlan = '';
        let selectedAmountUSD = 0;
        let selectedCountry = '';
        let selectedCryptoType = '';
        let selectedPaymentMethod = ''; // 'crypto', 'card', or 'manual'
        let selectedCardMethod = 'paystack';

        // Menu functions
        function toggleMenu() {
            const menuDropdown = document.getElementById('menuDropdown');
            menuDropdown.style.display = menuDropdown.style.display === 'block' ? 'none' : 'block';
        }

        function toggleProfileDetails() {
            const profileDetails = document.getElementById('profileDetails');
            profileDetails.style.display = profileDetails.style.display === 'block' ? 'none' : 'block';
        }

        // Plan functions
        function showPlan(plan) {
            document.querySelectorAll('.plan-section').forEach(section => section.classList.remove('active'));
            document.getElementById(plan).classList.add('active');
        }

        // Main payment entry point
        function payNow(plan) {
            selectedPlan = plan;
            selectedAmountUSD = parseFloat(document.getElementById(`amount_${plan}`).value);
            
            // Show country modal
            const countryModal = new bootstrap.Modal(document.getElementById('countryModal'));
            countryModal.show();
            
            document.getElementById('proceedCountryBtn').onclick = async function() {
                const country = document.getElementById('selectedCountry').value;
                if (!country) {
                    showBootstrapAlert('warning', 'Please select your country');
                    return;
                }
                
                selectedCountry = country;
                countryModal.hide();
                
                // Show payment method selection modal
                showPaymentMethodModal(country, selectedAmountUSD, plan);
            };
        }

        // Show payment method selection modal
        function showPaymentMethodModal(country, usdAmount, plan) {
            // Update modal content
            document.getElementById('paymentCountry').textContent = country;
            document.getElementById('paymentAmountUSD').textContent = usdAmount;
            document.getElementById('paymentPlan').textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' Plan';
            
            // Clear previous content
            const cryptoOptionsDiv = document.getElementById('cryptoOptions');
            cryptoOptionsDiv.innerHTML = '';
            
            // Add crypto options
            for (const [key, address] of Object.entries(CRYPTO_ADDRESSES)) {
                const iconClass = key === 'BTC' ? 'btc' : (key === 'USDT_ERC20' ? 'erc20' : 'trc20');
                const optionDiv = document.createElement('div');
                optionDiv.className = 'payment-option-card crypto-option';
                optionDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cryptoType" 
                               id="crypto${key}" value="${key}" onchange="selectCryptoOption('${key}')">
                        <label class="form-check-label" for="crypto${key}" style="width: 100%;">
                            <div class="d-flex align-items-center">
                                <i class="${CRYPTO_ICONS[key]} crypto-icon ${iconClass}"></i>
                                <div class="flex-grow-1">
                                    <strong>${CRYPTO_NAMES[key]}</strong><br>
                                    <div class="mt-1">
                                        <small class="text-muted">Address:</small><br>
                                        <div class="d-flex align-items-center mt-1">
                                            <code class="crypto-address flex-grow-1">${address}</code>
                                            <button type="button" class="btn btn-sm btn-outline-primary copy-btn" 
                                                    data-address="${address}">
                                                <i class="fas fa-copy"></i> Copy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                cryptoOptionsDiv.appendChild(optionDiv);
            }
            
            // Determine manual payment instructions
            let manualInstructions = '';
            if (country === "Kenya") {
                manualInstructions = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-mobile-alt"></i> MPesa Payment (Kenya Only)</h6>
                        <p>Pay with MPesa through Paystack. You'll be redirected to a secure payment page.</p>
                        <p><strong>Amount:</strong> KES equivalent of $${usdAmount}</p>
                    </div>
                `;
            } else {
                // Get local currency info
                let toCurrency = getLocalCurrency(country);
                manualInstructions = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-university"></i> Bank Transfer / Mobile Money</h6>
                        <p>Complete payment through your local bank or mobile money service.</p>
                        <p><strong>Amount:</strong> Local currency equivalent of $${usdAmount}</p>
                        <div id="manualInstructionsContent"></div>
                    </div>
                `;
            }
            
            document.getElementById('manualPaymentContent').innerHTML = manualInstructions;
            
            // Show payment method modal
            const paymentMethodModal = new bootstrap.Modal(document.getElementById('paymentMethodModal'));
            paymentMethodModal.show();
            
            // Setup payment method tabs
            setupPaymentMethodTabs(country, usdAmount, plan);
        }

        // Setup payment method tabs
        function setupPaymentMethodTabs(country, usdAmount, plan) {
            // Clear previous listeners
            document.getElementById('proceedCryptoBtn').onclick = null;
            document.getElementById('proceedCardBtn').onclick = null;
            document.getElementById('proceedManualBtn').onclick = null;
            
            // Crypto tab click handler
            document.getElementById('proceedCryptoBtn').onclick = function() {
                selectedPaymentMethod = 'crypto';
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentMethodModal'));
                modal.hide();
                showCryptoPaymentModal(country, usdAmount, plan);
            };
            
            // Card tab click handler
            document.getElementById('proceedCardBtn').onclick = function() {
                selectedPaymentMethod = 'card';
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentMethodModal'));
                modal.hide();
                processCardPayment(country, usdAmount, plan);
            };
            
            // Manual tab click handler
            document.getElementById('proceedManualBtn').onclick = function() {
                selectedPaymentMethod = 'manual';
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentMethodModal'));
                modal.hide();
                
                if (country === "Kenya") {
                    convertAndPayWithPaystack(plan);
                } else {
                    showManualPayment(country, usdAmount, plan);
                }
            };
            
            // Add copy functionality
            setTimeout(() => {
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.onclick = function() {
                        const address = this.getAttribute('data-address');
                        navigator.clipboard.writeText(address).then(() => {
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            setTimeout(() => {
                                this.innerHTML = originalText;
                            }, 2000);
                        });
                    };
                });
            }, 100);
        }

        // Get local currency for country
        function getLocalCurrency(country) {
            const currencyMap = {
                "Kenya": "KES",
                "Uganda": "UGX",
                "Rwanda": "RWF",
                "Tanzania": "TZS",
                "Zambia": "ZMW",
                "South Sudan": "SSP",
                "USA": "USD",
                "South Africa": "ZAR",
                "Nigeria": "NGN",
                "UAE": "AED",
                "Kuwait": "KWD",
                "Canada": "CAD"
            };
            return currencyMap[country] || "USD";
        }

        // Select crypto option
        function selectCryptoOption(type) {
            document.querySelectorAll('.crypto-option').forEach(opt => {
                if (opt.querySelector('input').value === type) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        // Process card payment for international users
async function processCardPayment(country, usdAmount, plan) {
    // Show loading
    showBootstrapAlert('info', 'Initializing international card payment...');
    
    try {
        const response = await fetch('/create_paystack_international_charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount_usd: usdAmount,
                plan: plan,
                country: country
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Open Paystack payment page in new tab
            const paymentWindow = window.open(data.authorization_url, '_blank', 'width=800,height=600');
            
            if (paymentWindow) {
                // Check payment status every 5 seconds
                const checkInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/check_paystack_international_payment/${data.reference}`);
                        const statusData = await statusResponse.json();
                        
                        if (statusData.status === 'completed') {
                            clearInterval(checkInterval);
                            paymentWindow.close();
                            
                            showBootstrapAlert('success', 'Payment successful! Your investment is now active.');
                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('Error checking payment status:', error);
                    }
                }, 5000);
                
                // Clear interval after 10 minutes
                setTimeout(() => clearInterval(checkInterval), 600000);
            } else {
                // If popup blocked, redirect in same window
                showBootstrapAlert('warning', 'Popup blocked. Redirecting to payment page...');
                setTimeout(() => {
                    window.location.href = data.authorization_url;
                }, 1000);
            }
        } else {
            showBootstrapAlert('danger', data.message || 'Failed to initialize card payment');
        }
    } catch (error) {
        showBootstrapAlert('danger', 'Network error. Please try again.');
        console.error('Card payment error:', error);
    }
}

        // Show crypto payment modal
        function showCryptoPaymentModal(country, usdAmount, plan) {
            // Update modal content
            document.getElementById('cryptoCountry').textContent = country;
            document.getElementById('cryptoAmountUSD').textContent = usdAmount;
            document.getElementById('cryptoPlan').textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' Plan';
            
            // Handle screenshot upload
            document.getElementById('screenshotInput').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('screenshotPreview').innerHTML = `
                            <img src="${event.target.result}" class="img-thumbnail" style="max-height: 200px;">
                            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearScreenshot()">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            // Set submit button handler
            document.getElementById('submitCryptoPaymentBtn').onclick = submitCryptoPayment;
            
            // Show crypto modal
            const cryptoModal = new bootstrap.Modal(document.getElementById('cryptoPaymentModal'));
            cryptoModal.show();
        }

        function clearScreenshot() {
            document.getElementById('screenshotInput').value = '';
            document.getElementById('screenshotPreview').innerHTML = '';
        }

        // Submit crypto payment
        async function submitCryptoPayment() {
            const cryptoType = document.querySelector('input[name="cryptoType"]:checked');
            const screenshotInput = document.getElementById('screenshotInput');
            
            if (!cryptoType) {
                showBootstrapAlert('warning', 'Please select a cryptocurrency');
                return;
            }
            
            if (!screenshotInput.files[0]) {
                showBootstrapAlert('warning', 'Please upload a payment screenshot');
                return;
            }
            
            selectedCryptoType = cryptoType.value;
            
            // Read screenshot as base64
            const file = screenshotInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                const base64Screenshot = event.target.result;
                
                // Get wallet address
                const walletAddress = CRYPTO_ADDRESSES[selectedCryptoType];
                
                // Show loading
                const submitBtn = document.getElementById('submitCryptoPaymentBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';
                
                // Submit to backend
                try {
                    const response = await fetch('/submit_crypto_payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount_usd: selectedAmountUSD,
                            plan: selectedPlan,
                            country: selectedCountry,
                            crypto_type: selectedCryptoType,
                            wallet_address: walletAddress,
                            payment_screenshot: base64Screenshot
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showBootstrapAlert('success', data.message);
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('cryptoPaymentModal'));
                            modal.hide();
                            window.location.href = '/dashboard';
                        }, 2000);
                    } else {
                        showBootstrapAlert('danger', data.message || 'Submission failed');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                } catch (error) {
                    showBootstrapAlert('danger', 'Network error. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Kenya: use Paystack
        async function convertAndPayWithPaystack(plan) {
            const amountUSD = selectedAmountUSD;
            const email = "{{ session.get('user_email', '') }}";

            if (!email) {
                showBootstrapAlert('danger', 'You must be logged in to invest.');
                window.location.href = "/login?next=/invest";
                return;
            }

            try {
                // Show loading state
                const payButton = document.querySelector(`#${plan} button`);
                const originalText = payButton.innerHTML;
                payButton.disabled = true;
                payButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

                // Convert USD to KES
                const conversionResponse = await fetch(`/convert_currency?amount=${amountUSD}&from=USD&to=KES`);
                const conversionData = await conversionResponse.json();

                if (conversionData.error) {
                    showBootstrapAlert('danger', conversionData.error);
                    payButton.disabled = false;
                    payButton.innerHTML = originalText;
                    return;
                }

                const amountKES = Math.round(conversionData.converted);

                // Initialize Paystack payment
                const paymentResponse = await fetch("/initialize_transaction", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        amount: amountKES,
                        plan: plan
                    })
                });

                const paymentData = await paymentResponse.json();

                if (paymentData.status && paymentData.data.authorization_url) {
                    // Open Paystack in same window
                    window.location.href = paymentData.data.authorization_url;
                } else {
                    showBootstrapAlert('danger', paymentData.message || "Payment initialization failed");
                    payButton.disabled = false;
                    payButton.innerHTML = originalText;
                }
            } catch (error) {
                const payButton = document.querySelector(`#${plan} button`);
                payButton.disabled = false;
                payButton.innerHTML = originalText;
                showBootstrapAlert('danger', error.message || "Payment failed");
            }
        }

        // Manual Payment for other countries
        async function showManualPayment(country, usdAmount, plan) {
            // Determine local currency
            let toCurrency = getLocalCurrency(country);
            
            // Convert USD to local
            let amountLocal = 0;
            let rate = 1;
            try {
                const resp = await fetch(`/convert_currency?amount=${usdAmount}&from=USD&to=${toCurrency}`);
                const data = await resp.json();
                amountLocal = data.converted;
                rate = data.rate;
            } catch (e) { 
                amountLocal = usdAmount; 
            }

            // Build payment instructions
            let instructions = '';
            if (country === 'Uganda') {
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>MTN UGANDA</b>
                        <ol class="mb-1">
                            <li>Dial *165*1#</li>
                            <li>Select send money</li>
                            <li>East Africa</li>
                            <li>Safaricom(mpesa) KENYA</li>
                            <li>Enter <b>254769823817</b> as the receiver number</li>
                        </ol>
                        <hr class="my-2">
                        <b>AIRTEL UGANDA</b>
                        <ol class="mb-0">
                            <li>Dial *185*1#</li>
                            <li>Select send money</li>
                            <li>International transfer</li>
                            <li>Eastern Africa</li>
                            <li>Kenya</li>
                            <li>Safaricom(mpesa)</li>
                            <li>Enter <b>254769823817</b> as the receiver number</li>
                            <li>Reason: Any</li>
                        </ol>
                    </div>
                `;
            } else if (country === 'Rwanda') {
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>MTN RWANDA</b>
                        <ol class="mb-1">
                            <li>Dial *182#</li>
                            <li>Select send money</li>
                            <li>International transfer</li>
                            <li>Safaricom(mpesa) KENYA</li>
                            <li>Enter <b>254769823817</b> as the receiver number</li>
                        </ol>
                        <hr class="my-2">
                        <b>OR</b>
                        <ol class="mb-0">
                            <li>Dial *830#</li>
                            <li>Select send money</li>
                            <li>International transfer</li>
                            <li>Safaricom(mpesa) KENYA</li>
                            <li>Enter <b>254769823817</b> as the receiver number</li>
                        </ol>
                    </div>
                `;
            } else if (country === 'Tanzania') {
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>MPESA TANZANIA</b>
                        <ol class="mb-1">
                            <li>Dial *150*00#</li>
                            <li>Select send money</li>
                            <li>Select Mpesa Kenya</li>
                            <li>Enter number <b>+254769823817</b></li>
                            <li>Enter amount and then pin</li>
                        </ol>
                        <hr class="my-2">
                        <b>AIRTEL TANZANIA</b>
                        <ol class="mb-1">
                            <li>Dial *150*60#</li>
                            <li>Select send money</li>
                            <li>Choose international transfer</li>
                            <li>Select Kenya</li>
                            <li>Enter <b>+254769823817</b></li>
                            <li>Enter amount and then pin</li>
                        </ol>
                        <hr class="my-2">
                        <b>TIGO TANZANIA</b>
                        <ol class="mb-0">
                            <li>Dial *150*01#</li>
                            <li>Select send money</li>
                            <li>Select send out of the country</li>
                            <li>Select Kenya</li>
                            <li>Enter <b>254769823817</b></li>
                            <li>Enter amount and then pin</li>
                        </ol>
                    </div>
                `;
            } else if (country === 'Zambia') {
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>AIRTEL ZAMBIA</b>
                        <ol class="mb-0">
                            <li>Dial *115#</li>
                            <li>Select send money</li>
                            <li>Choose international transfer</li>
                            <li>Select Kenya</li>
                            <li>Enter <b>254769823817</b></li>
                            <li>Enter amount and then pin</li>
                        </ol>
                    </div>
                `;
            } else if (country === 'South Sudan') {
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>M-Gurush SOUTH SUDAN</b>
                        <ol class="mb-0">
                            <li>Dial *355#</li>
                            <li>Enter your m-Gurush pin</li>
                            <li>Select international remittances</li>
                            <li>Choose Kenya</li>
                            <li>Select Mpesa(safaricom)</li>
                            <li>Enter <b>254769823817</b></li>
                            <li>Enter amount and your m-Gurush pin</li>
                        </ol>
                    </div>
                `;
            } else {
                // Generic instructions for other countries
                instructions = `
                    <h6>Pay <b>${amountLocal.toFixed(2)} ${toCurrency}</b> (≈ $${usdAmount} USD)</h6>
                    <div class="alert alert-info">
                        <b>Bank Transfer Instructions:</b>
                        <ol class="mb-0">
                            <li>Send payment to our receiving account</li>
                            <li>Account Name: BIG WINNERS INVESTMENT</li>
                            <li>Account Number: 1234567890</li>
                            <li>Bank: Standard Chartered Bank</li>
                            <li>SWIFT/BIC: SCBLKENXXXX</li>
                            <li>Amount: ${amountLocal.toFixed(2)} ${toCurrency}</li>
                            <li>Reference: ${selectedPlan.toUpperCase()}_${Date.now().toString().slice(-6)}</li>
                        </ol>
                    </div>
                `;
            }

            // Add transaction/reference ID field
            const modalInstructions = `
                ${instructions}
                <hr>
                <div class="mb-3">
                    <label for="manualTransactionIdInput" class="form-label">
                        <b><i class="fas fa-receipt"></i> Transaction/Reference ID:</b>
                    </label>
                    <input type="text" class="form-control" id="manualTransactionIdInput" 
                           placeholder="Enter your payment transaction/reference ID">
                    <div class="form-text">This is the reference number from your payment confirmation</div>
                </div>
                <div id="manualPaymentFeedback"></div>
            `;

            document.getElementById('manualPaymentInstructions').innerHTML = modalInstructions;

            // Show modal
            const manualPaymentModal = new bootstrap.Modal(document.getElementById('manualPaymentModal'));
            manualPaymentModal.show();

            // Handle "I have paid"
            document.getElementById('confirmManualPaymentBtn').onclick = async function () {
                const transactionId = document.getElementById('manualTransactionIdInput').value.trim();
                const feedbackDiv = document.getElementById('manualPaymentFeedback');
                feedbackDiv.innerHTML = "";
                
                if (!transactionId) {
                    feedbackDiv.innerHTML = `<div class="alert alert-warning alert-dismissible fade show" role="alert">
                        Please enter your payment transaction/reference ID.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                    return;
                }
                
                // Send payment notice to backend
                const res = await fetch('/manual_payment_notice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount_usd: usdAmount,
                        local_amount: amountLocal,
                        plan: plan,
                        country: country,
                        transaction_id: transactionId
                    })
                });
                
                const data = await res.json();
                if (data.status === 'pending') {
                    feedbackDiv.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> Your payment is pending approval. You will be notified once it is confirmed.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                    
                    setTimeout(() => {
                        manualPaymentModal.hide();
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    feedbackDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                        ${data.message || 'Failed to submit payment notice. Try again.'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                }
            };
        }

        // Helper function for alerts
        function showBootstrapAlert(type, message) {
            let alertId = "main-bootstrap-alert";
            let old = document.getElementById(alertId);
            if (old) old.remove();
            
            let alertDiv = document.createElement("div");
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.role = "alert";
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Initialize with Standard plan showing
        document.addEventListener('DOMContentLoaded', function() {
            showPlan('standard');
        });
    </script>

    <!-- Country Selection Modal -->
    <div class="modal fade" id="countryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-globe"></i> Select Your Country</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select class="form-select form-select-lg" id="selectedCountry">
                        <option value="" disabled selected>Select Your Country</option>
                        <!-- African countries -->
                        <option value="Kenya">Kenya</option>
                        <option value="Uganda">Uganda</option>
                        <option value="Rwanda">Rwanda</option>
                        <option value="Tanzania">Tanzania</option>
                        <option value="Zambia">Zambia</option>
                        <option value="South Sudan">South Sudan</option>
                        <!-- New countries with crypto payments -->
                        <option value="USA">United States (USA)</option>
                        <option value="Canada">Canada</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="UAE">United Arab Emirates (UAE)</option>
                        <option value="Kuwait">Kuwait</option>
                    </select>
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Available Payment Methods:</strong><br>
                            • All Countries: Cryptocurrency (BTC, USDT)<br>
                            • All Countries: International Card Payment (Visa, Mastercard, Amex)<br>
                            • Kenya: MPesa via Paystack<br>
                            • Other Countries: Bank Transfer / Mobile Money
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-lg" id="proceedCountryBtn">
                        <i class="fas fa-arrow-right"></i> Proceed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div class="modal fade" id="paymentMethodModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-credit-card"></i> Choose Payment Method - <span id="paymentCountry"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-primary">
                        <h6><i class="fas fa-info-circle"></i> Payment Details:</h6>
                        <p><strong>Plan:</strong> <span id="paymentPlan"></span></p>
                        <p><strong>Amount:</strong> $<span id="paymentAmountUSD"></span> USD</p>
                        <p><strong>Country:</strong> <span id="paymentCountryText"></span></p>
                    </div>
                    
                    <div class="payment-method-tabs">
                        <ul class="nav nav-tabs" id="paymentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="crypto-tab" data-bs-toggle="tab" 
                                        data-bs-target="#crypto-tab-pane" type="button" role="tab">
                                    <i class="fab fa-bitcoin"></i> Cryptocurrency
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="card-tab" data-bs-toggle="tab" 
                                        data-bs-target="#card-tab-pane" type="button" role="tab">
                                    <i class="fas fa-credit-card"></i> Card Payment
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                                        data-bs-target="#manual-tab-pane" type="button" role="tab">
                                    <i class="fas fa-university"></i> Traditional Payment
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-4" id="paymentTabsContent">
                            <!-- Cryptocurrency Tab -->
                            <div class="tab-pane fade show active" id="crypto-tab-pane" role="tabpanel">
                                <h6><i class="fas fa-coins"></i> Select Cryptocurrency:</h6>
                                <div id="cryptoOptions" class="mb-4">
                                    <!-- Crypto options will be inserted here -->
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Important Instructions:</strong> 
                                    <ul class="mb-0 mt-2">
                                        <li>Send the <strong>exact amount in USD equivalent</strong></li>
                                        <li>Make sure to use the <strong>correct network</strong> (ERC20 vs TRC20)</li>
                                        <li>Keep the <strong>transaction hash/ID</strong> for reference</li>
                                        <li>Your payment will be reviewed within <strong>24 hours</strong></li>
                                    </ul>
                                </div>
                                
                                <button class="btn btn-success btn-lg w-100" id="proceedCryptoBtn">
                                    <i class="fab fa-bitcoin"></i> Continue with Cryptocurrency
                                </button>
                            </div>
                            
                            <!-- Card Payment Tab -->
                           <!-- Card Payment Tab -->
<div class="tab-pane fade" id="card-tab-pane" role="tabpanel">
    <h6><i class="fas fa-credit-card"></i> International Card Payment:</h6>
    <div class="alert alert-success">
        <i class="fas fa-globe-americas"></i>
        <strong>Available Worldwide:</strong> 
        <p class="mb-2">Pay with Visa, Mastercard, or American Express from any country.</p>
        <ul class="mb-0">
            <li><strong>Currency:</strong> USD (Charged in your local currency)</li>
            <li><strong>Processing Time:</strong> Instant activation</li>
            <li><strong>Secure Payment:</strong> 256-bit SSL encryption</li>
            <li><strong>Supported Cards:</strong> Visa, Mastercard, American Express</li>
        </ul>
    </div>
    
    <div class="d-flex mb-3">
        <i class="fab fa-cc-visa card-icons visa me-2"></i>
        <i class="fab fa-cc-mastercard card-icons mastercard me-2"></i>
        <i class="fab fa-cc-amex card-icons amex"></i>
    </div>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>Note:</strong> 
        <ul class="mb-0">
            <li>Your card will be charged in <strong>USD ${usdAmount}</strong></li>
            <li>Your bank will convert this to your local currency</li>
            <li>Exchange rates and fees are determined by your card issuer</li>
            <li>Payment is processed through Paystack's secure gateway</li>
        </ul>
    </div>
    
    <button class="btn btn-primary btn-lg w-100 mt-3" id="proceedCardBtn">
        <i class="fas fa-credit-card"></i> Pay ${usdAmount} USD with Card
    </button>
</div>
                            
                            <!-- Manual Payment Tab -->
                            <div class="tab-pane fade" id="manual-tab-pane" role="tabpanel">
                                <div id="manualPaymentContent">
                                    <!-- Manual payment content will be inserted here -->
                                </div>
                                
                                <button class="btn btn-primary btn-lg w-100" id="proceedManualBtn">
                                    <i class="fas fa-university"></i> Continue with Traditional Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto Payment Modal -->
    <div class="modal fade" id="cryptoPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="fab fa-bitcoin"></i> Cryptocurrency Payment - <span id="cryptoCountry"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-primary">
                        <h6><i class="fas fa-info-circle"></i> Payment Details:</h6>
                        <p><strong>Plan:</strong> <span id="cryptoPlan"></span></p>
                        <p><strong>Amount:</strong> $<span id="cryptoAmountUSD"></span> USD</p>
                        <p><strong>Country:</strong> <span id="cryptoCountryText"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="screenshotInput" class="form-label">
                            <strong><i class="fas fa-camera"></i> Upload Payment Screenshot:</strong>
                        </label>
                        <input type="file" class="form-control" id="screenshotInput" accept="image/*">
                        <div class="form-text">Take a screenshot of your crypto wallet showing the completed transaction</div>
                        <div id="screenshotPreview" class="mt-2"></div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Crypto Addresses:</strong> 
                        <ul class="mb-0 mt-2">
                            <li><strong>Bitcoin (BTC):</strong> <code>13EcmrfxyUSKDrWbJBsjRU2ho92RJdTixL</code></li>
                            <li><strong>USDT (ERC20):</strong> <code>0x7a3544ab71d616f0f858913e416817c22631b830</code></li>
                            <li><strong>USDT (TRC20):</strong> <code>TUe3Qdf9d4xueX9F7viJLZCwRZxgx2hbze</code></li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success btn-lg" id="submitCryptoPaymentBtn">
                        <i class="fas fa-paper-plane"></i> Submit Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Payment Modal -->
    <div class="modal fade" id="manualPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-university"></i> Payment Instructions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="manualPaymentInstructions">
                    <!-- Content is set by JS -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success btn-lg" id="confirmManualPaymentBtn">
                        <i class="fas fa-check-circle"></i> I Have Paid
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

<footer>
    <p>&copy; 2025 Big Winners. All rights reserved.</p>
</footer>

</html>